name: Wake Up Render App

on:
  schedule:
    - cron: "55 14 * * *"
  workflow_dispatch:

jobs:
  wake_up:
    runs-on: ubuntu-latest
    steps:
      - name: Wake up Render app before midnight job
        run: |
          echo "🌐 Pinging Render app to wake it up before midnight..."
          RESPONSE=$(curl -s -o /dev/null -w "%{http_code}" https://my-japan.onrender.com/api/v1/auth/health)
          if [ "$RESPONSE" -eq 200 ]; then
            STATUS_MSG="✅ Render app responded with 200 OK"
          else
            STATUS_MSG="⚠️ Render app did not respond (HTTP $RESPONSE)"
          fi
          echo "$STATUS_MSG"
          echo "STATUS_MSG=$STATUS_MSG" >> $GITHUB_ENV

      - name: Send Telegram notification
        if: always()
        run: |
          echo "📨 Sending Telegram notification..."
          curl -s -X POST "https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/sendMessage" \
          -d "chat_id=${{ secrets.TELEGRAM_CHAT_ID }}" \
          -d "text=Wake Up Render App:%0A${{ env.STATUS_MSG }}%0ATime: $(date -u '+%Y-%m-%d %H:%M:%S UTC')"

      - name: Send Gmail notification
        if: always()
        run: |
          echo "📧 Sending Gmail notification..."

          SUBJECT="Wake Up Render App Result"
          BODY="Wake Up Render App:
          ${{ env.STATUS_MSG }}
          Time: $(date -u '+%Y-%m-%d %H:%M:%S UTC')"

          {
            echo "EHLO smtp.gmail.com"
            echo "AUTH LOGIN"
            echo -n "${{ secrets.GMAIL_USER }}" | base64
            echo
            echo -n "${{ secrets.GMAIL_PASS }}" | base64
            echo
            echo "MAIL FROM:<${{ secrets.GMAIL_USER }}>"
            echo "RCPT TO:<${{ secrets.GMAIL_TO }}>"
            echo "DATA"
            echo "Subject: $SUBJECT"
            echo "From: GitHub Actions <${{ secrets.GMAIL_USER }}>"
            echo "To: ${{ secrets.GMAIL_TO }}"
            echo
            echo "$BODY"
            echo "."
            echo "QUIT"
          } | openssl s_client -crlf -quiet -connect smtp.gmail.com:465 -ign_eof
