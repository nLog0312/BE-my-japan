name: Wake Up Render App

on:
  schedule:
    - cron: "55 14 * * *"
  workflow_dispatch:

jobs:
  wake_up:
    runs-on: ubuntu-latest
    steps:
      - name: üïê Start workflow
        run: echo "üöÄ Workflow started at $(date -u '+%Y-%m-%d %H:%M:%S UTC')"

      - name: üß© Checkout latest code
        uses: actions/checkout@v4

      - name: üåê Wake up Render app before midnight job
        id: wakeup
        run: |
          echo "üîî Pinging Render app..."
          RESPONSE=$(curl -s -o /dev/null -w "%{http_code}" https://my-japan.onrender.com/api/v1/auth/health)
          echo "HTTP_RESPONSE=$RESPONSE" >> $GITHUB_ENV
          if [ "$RESPONSE" -eq 200 ]; then
            echo "‚úÖ Render app responded with 200 OK"
          else
            echo "‚ö†Ô∏è Render app did not respond (HTTP $RESPONSE)"
            exit 1
          fi

      - name: üïì Finish workflow
        run: echo "üéâ Workflow completed at $(date -u '+%Y-%m-%d %H:%M:%S UTC')"

      - name: üì¨ Send notifications
        if: always()
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
          EMAIL_FROM: ${{ secrets.EMAIL_FROM }}
          EMAIL_TO: ${{ secrets.EMAIL_TO }}
          EMAIL_PASS: ${{ secrets.EMAIL_PASS }}
          RESPONSE: ${{ env.HTTP_RESPONSE }}
        run: |
          STATUS_MSG="‚úÖ Render app responded with 200 OK"
          if [ "$RESPONSE" != "200" ]; then
            STATUS_MSG="‚ö†Ô∏è Render app did not respond (HTTP $RESPONSE)"
          fi

          TIME=$(date -u '+%Y-%m-%d %H:%M:%S UTC')

          echo "üì® Sending Telegram notification..."
          curl -s -X POST https://api.telegram.org/bot$TELEGRAM_BOT_TOKEN/sendMessage \
            -d chat_id=$TELEGRAM_CHAT_ID \
            -d text="Wake Up Render App:\n$STATUS_MSG\nTime: $TIME"

          echo "üìß Sending Gmail notification..."
          echo -e "Subject: [Wake Up Render App] $STATUS_MSG\n\n$STATUS_MSG\nTime: $TIME" | \
            openssl s_client -crlf -quiet -starttls smtp -connect smtp.gmail.com:587 \
            -auth login -user "$EMAIL_FROM" -pass "$EMAIL_PASS" \
            -from "$EMAIL_FROM" -to "$EMAIL_TO"
